<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="http://ricegnat.com/resources/modern/modern.css" />
    <link rel="stylesheet" type="text/css" href="http://ricegnat.com/resources/modern/modern.dark.css" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="stylesheet" type="text/css" href="/card.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
        var boards = ["main", "side", "maybe", "acquire"];
        var types = ["sorcery", "instant", "enchantment", "artifact", "planeswalker", "creature", "land"];

        function LoadPaste(decklist) {
            var regex = /^(\d{1,3})x (.+)$/gm;
            var m = regex.exec(decklist);
            var cards = [];
            var count = 0;
            var i = 0;
            while (m != null) {
                var quantity = parseInt(m[1]);
                var name = m[2].trim();
                cards[i] = {
                    name: name,
                    board: "main",
                    quantity: quantity,
                    set: "",
                    foil: false,
                    alter: false,
                    signed: false,
                    language: "en"
                }
                count += quantity;
                i++;
                m = regex.exec(decklist)
            }
            deck = {
                count: count,
                list: cards
            }

            ChangeView("", function () {
                $("#deckTitle").empty();
                $("#deckInfo").empty();
                $(".card-area").empty();
                loadedCards = 0;

                $("#deckTitle").text("Deck paste");
                $("#deckInfo").append(`<li><b>Cards</b>&ensp;${deck.count}</li>`);

                LoadCards();

                $("#deckTitle").removeClass("hidden");
                $("#deckInfo").removeClass("hidden");
                $("#defaultView").show().removeClass("hidden");
            })
        }


        function SortCards(deck) {
            $("#sortedView .section").hide();
            $("#sortedView").removeClass("commander");

            boards.forEach(function (board) {
                var cards = $(`.card-area .card.${board}`);
                if (cards.length > 0) {
                    $(`#sortedView .section.${board}`).show();

                    if (board == "main") {
                        var context = $(`#sortedView .section.${board}`);

                        $("h3", context).hide();
                        cards.appendTo(".section.other .card-area", context);

                        types.forEach(function (type) {
                            var subset = cards.filter(`.card.${type}`);

                            if (subset.length > 0) {
                                $(`.section.${type}`, context).show();
                                subset.appendTo(`.section.${type} .card-area`, context);
                                $(`.section.${type} .count`, context).text(subset.length);
                            }
                        });

                        if (deck.commander) {
                            $(".section.commander", context).show();
                            deck.commander.forEach(function (element) {
                                cards.filter(`.card:contains(${element})`).appendTo(".section.commander .card-area", context);
                            });
                            $("#sortedView").addClass("commander");
                        }

                        if ($(".section.other .card-area .card", context).length > 0) {
                            $(".section.other", context).show();
                        }
                    }
                    else {
                        $("#sortedView .section.main h3").show();
                        cards.appendTo(`#sortedView .section.${board} .card-area`);
                    }

                    $(`#sortedView .section.${board} h3 .count`).text($(`#sortedView .section.${board} .card`).length);
                }
            });

            StackCards(deck);
        }

        function StackCards(deck) {
            deck.list.forEach(function (card) {
                var stack = $("#sortedView .card").map(function () {
                    if (card.name == $(".card-title", this).text()) {
                        return this;
                    }
                });

                if (stack.length > 1) {
                    for (var i = 1; i < stack.length; i++) {
                        if (i % 4 != 0) $(stack[i - 1]).append(stack[i]);
                    }
                }
            });

            $(".card").draggable();
        }

        function ChangeView(id, restage) {
            $(".view").addClass("hidden");
            setTimeout(function () {
                $(".view").hide();
                if (typeof restage === "function") restage();
                $(id).show().removeClass("hidden");
            }, 500);
        }

        /* Draggable */{
            var heldRef;
            $.fn.extend({
                draggable: function () {
                    return this.each(function () {
                        $(this).on("mousedown.draggable", function (e) {
                            $(this).addClass("held");
                            $(this).closest(".card-area > .card").addClass("held-root");
                            heldRef = {
                                x: e.pageX,
                                y: e.pageY
                            };
                            e.stopPropagation();
                        });
                    });
                }
            });

            $(window).on("mouseup.draggable", function (e) {
                $(".card.held").removeClass("held").removeAttr("style");
                $(".card.held-root").removeClass("held-root");
                heldRef = null;
            }).on("mousemove.draggable", function (e) {
                if (heldRef) {
                    $(".card.held").css({
                        "left": e.pageX - heldRef.x,
                        "top": e.pageY - heldRef.y
                    });
                }
            });
        }

        $(function () {
            // $("#searchForm").on("submit", function () {
            //     LoadDeck();
            //     return false;
            // })

            $("#pasteForm").on("submit", function () {
                LoadPaste($("#deckPaste").val());
                return false;
            })

        });
    </script>
</head>
<body class="modern">
    <div id="app">
        <div class="header">
            <div id="controlBar">
                <form id="pasteForm">
                    <textarea id="deckPaste" class="modern"></textarea> <input type="submit" id="loadPaste" value="Load deck paste" />
                </form>
            </div>
        </div>
    <script src="/bundle.js"></script>
</body>
</html>